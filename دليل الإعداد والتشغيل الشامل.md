# دليل الإعداد والتشغيل الشامل

هذا الدليل يوضح كيفية إعداد وتشغيل بوت Infobip Telegram من البداية إلى النهاية.

## المتطلبات الأساسية

قبل البدء، تأكد من توفر ما يلي:

1. **حساب Infobip**
   - زيارة [موقع Infobip](https://www.infobip.com/)
   - إنشاء حساب وتسجيل الدخول
   - الحصول على `API Key` من صفحة إدارة المفاتيح
   - الحصول على `Base URL` من لوحة التحكم

2. **بوت Telegram**
   - التحدث مع [@BotFather](https://t.me/BotFather) على Telegram
   - إنشاء بوت جديد باستخدام الأمر `/newbot`
   - الحصول على `Bot Token`
   - الحصول على `Chat ID` الخاص بك

3. **بيئة التطوير**
   - PHP 8.1 أو أحدث
   - Composer
   - Git (اختياري)

## خطوات التثبيت

### الخطوة 1: استنساخ أو تحميل المشروع

```bash
# إذا كان لديك Git
git clone https://github.com/your-username/infobip-telegram-bot.git
cd infobip-telegram-bot

# أو قم بتحميل الملفات يدويًا
```

### الخطوة 2: تثبيت الاعتماديات

```bash
composer install
```

سيقوم هذا الأمر بتثبيت جميع المكتبات المطلوبة:
- `infobip/infobip-api-php-client` - عميل Infobip API
- `guzzlehttp/guzzle` - مكتبة HTTP
- `vlucas/phpdotenv` - لتحميل متغيرات البيئة

### الخطوة 3: إعداد ملف التكوين

1. انسخ ملف `.env.example` إلى `.env`:
   ```bash
   cp .env.example .env
   ```

2. قم بتحرير ملف `.env` وأضف بيانات الاعتماد الخاصة بك:
   ```bash
   nano .env
   # أو استخدم أي محرر نصوص آخر
   ```

3. ملء البيانات:
   ```ini
   # Infobip Configuration
   INFOBIP_BASE_URL=2ydkvw.api.infobip.com
   INFOBIP_API_KEY=your_api_key_here

   # Telegram Configuration
   TELEGRAM_BOT_TOKEN=your_bot_token_here
   TELEGRAM_CHAT_ID=your_chat_id_here

   # Application
   APP_ENV=development
   APP_DEBUG=true
   ```

## التشغيل المحلي (للتطوير)

### الطريقة 1: استخدام الخادم المدمج

```bash
php server.php
```

سيقوم هذا بتشغيل خادم على `http://127.0.0.1:8000`.

### الطريقة 2: استخدام Apache أو Nginx

إذا كنت تستخدم خادم ويب محلي، تأكد من أن جذر المستند يشير إلى مجلد المشروع.

## إعداد Webhook

لكي يتمكن Telegram من إرسال الرسائل إلى البوت، تحتاج إلى إعداد Webhook.

### الخطوة 1: إنشاء نفق آمن باستخدام ngrok

1. قم بتحميل [ngrok](https://ngrok.com/)
2. قم بتشغيل ngrok:
   ```bash
   ngrok http 8000
   ```
3. ستحصل على رابط مثل: `https://xxxx-xxxx.ngrok.io`

### الخطوة 2: تعيين Webhook

استخدم أداة مثل `curl` لتعيين Webhook:

```bash
curl -F "url=https://xxxx-xxxx.ngrok.io/webhook.php" \
  https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook
```

استبدل:
- `xxxx-xxxx.ngrok.io` برابط ngrok الخاص بك
- `<YOUR_BOT_TOKEN>` برمز البوت الخاص بك

### الخطوة 3: التحقق من Webhook

للتحقق من أن Webhook تم تعيينه بشكل صحيح:

```bash
curl https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo
```

يجب أن ترى استجابة تحتوي على رابط Webhook الذي قمت بتعيينه.

## الاختبار

### اختبار اتصال Telegram

```bash
php cli.php test-telegram
```

يجب أن ترى معلومات البوت إذا كان الاتصال ناجحًا.

### إرسال رسالة اختبار

```bash
php cli.php send-test-message
```

يجب أن تستقبل رسالة اختبار في Telegram.

### إرسال رسالة SMS

```bash
php cli.php send-sms +1234567890 "Hello from CLI"
```

## التفاعل مع البوت

1. افتح Telegram وابحث عن البوت الخاص بك
2. أرسل الأمر `/start`
3. استخدم الأزرار التفاعلية لإرسال الرسائل

## الأوامر المتاحة

| الأمر | الوصف |
|------|-------|
| `/start` | بدء البوت والقائمة الرئيسية |
| `/help` | عرض قائمة الأوامر |
| `/send_sms` | إرسال رسالة SMS |
| `/send_whatsapp` | إرسال رسالة WhatsApp |
| `/send_email` | إرسال رسالة Email |
| `/status` | حالة البوت |
| `/about` | معلومات عن البوت |

## استكشاف الأخطاء

### المشكلة: "فشل الاتصال بـ Telegram"

**الحل**:
- تحقق من أن `TELEGRAM_BOT_TOKEN` صحيح
- تحقق من اتصال الإنترنت
- جرب الأمر `php cli.php test-telegram`

### المشكلة: "فشل إرسال الرسالة عبر Infobip"

**الحل**:
- تحقق من أن `INFOBIP_API_KEY` و `INFOBIP_BASE_URL` صحيحان
- تحقق من أن رقم الهاتف بالصيغة الصحيحة (مثال: +201001234567)
- تحقق من أن لديك رصيد في حساب Infobip

### المشكلة: "Webhook لا يستقبل الرسائل"

**الحل**:
- تأكد من أن ngrok قيد التشغيل
- تحقق من أن رابط Webhook صحيح باستخدام `getWebhookInfo`
- تحقق من ملفات السجل في مجلد `logs/`

### المشكلة: "خطأ في الأذونات"

**الحل**:
```bash
chmod -R 755 logs/
chmod -R 755 data/
```

## الملفات المهمة

| الملف | الوصف |
|------|-------|
| `.env` | ملف التكوين (لا تشاركه مع الآخرين) |
| `webhook.php` | نقطة دخول Webhook |
| `cli.php` | واجهة سطر الأوامر |
| `server.php` | مشغل الخادم المحلي |
| `src/Config.php` | فئة التكوين |
| `src/Services/TelegramService.php` | خدمة Telegram |
| `src/Services/InfobipService.php` | خدمة Infobip |
| `src/CommandHandler.php` | معالج الأوامر |

## الخطوات التالية

بعد التثبيت والاختبار الناجح، يمكنك:

1. **نشر البوت على خادم إنتاج**:
   - استخدم خادم ويب حقيقي (مثل AWS, Heroku, DigitalOcean)
   - قم بتحديث `INFOBIP_BASE_URL` و `TELEGRAM_BOT_TOKEN` في متغيرات البيئة

2. **إضافة ميزات جديدة**:
   - قم بإنشاء فئات خدمة جديدة في `src/Services/`
   - أضف معالجات أوامر جديدة في `src/CommandHandler.php`

3. **إعداد قاعدة بيانات**:
   - قم بتثبيت مكتبة قاعدة بيانات (مثل Doctrine أو Laravel)
   - احفظ سجل الرسائل والمستخدمين

## الدعم والمساعدة

إذا واجهت أي مشاكل:

1. تحقق من ملفات السجل في مجلد `logs/`
2. جرب الأوامر من واجهة سطر الأوامس
3. تحقق من بيانات الاعتماد في ملف `.env`
4. اقرأ التوثيق الرسمية لـ [Infobip](https://www.infobip.com/docs/api) و [Telegram](https://core.telegram.org/bots/api)
