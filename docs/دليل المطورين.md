# دليل المطورين

هذا الدليل يوضح كيفية توسيع وتطوير بوت Infobip Telegram.

## بنية المشروع

```
src/
├── Config.php              # فئة التكوين والمتغيرات البيئية
├── CommandHandler.php      # معالج الأوامر الرئيسي
├── Services/
│   ├── TelegramService.php # خدمة التفاعل مع Telegram API
│   └── InfobipService.php  # خدمة التفاعل مع Infobip API
├── Models/                 # نماذج البيانات (للتوسع المستقبلي)
└── Commands/               # معالجات الأوامر المتقدمة (للتوسع المستقبلي)
```

## إضافة أمر جديد

### الخطوة 1: إضافة معالج الأمر في `CommandHandler.php`

```php
private function handleCommand(string $command): void
{
    $parts = explode(' ', $command, 2);
    $cmd = strtolower($parts[0]);
    $args = $parts[1] ?? '';

    match ($cmd) {
        // ... الأوامر الموجودة
        '/my_new_command' => $this->commandMyNewCommand($args),
    };
}
```

### الخطوة 2: إنشاء دالة المعالج

```php
private function commandMyNewCommand(string $args): void
{
    $message = "✨ <b>أمر جديد</b>\n\n";
    $message .= "هذا أمر جديد تم إضافته للبوت";

    $this->telegramService->sendMessage($this->chatId, $message);
}
```

## إضافة خدمة جديدة

### مثال: خدمة إرسال الفاكس

1. **إنشاء ملف جديد**: `src/Services/FaxService.php`

```php
<?php

namespace InfobipBot\Services;

use Infobip\Configuration;
use Infobip\Api\FaxApi;
use Infobip\ApiException;
use InfobipBot\Config;

class FaxService
{
    private Configuration $configuration;
    private FaxApi $faxApi;

    public function __construct()
    {
        $this->configuration = new Configuration(
            host: Config::get('infobip.base_url'),
            apiKey: Config::get('infobip.api_key')
        );

        $this->faxApi = new FaxApi(config: $this->configuration);
    }

    public function sendFax(string $phoneNumber, string $filePath): array
    {
        try {
            // منطق إرسال الفاكس
            return [
                'success' => true,
                'message' => 'تم إرسال الفاكس بنجاح'
            ];
        } catch (ApiException $e) {
            return [
                'success' => false,
                'error' => $e->getMessage()
            ];
        }
    }
}
```

2. **استخدام الخدمة الجديدة**:

```php
// في CommandHandler.php
private FaxService $faxService;

public function __construct(array $update)
{
    // ... الكود الموجود
    $this->faxService = new FaxService();
}
```

## إضافة نموذج بيانات

### مثال: نموذج المستخدم

```php
<?php

namespace InfobipBot\Models;

class User
{
    private int $id;
    private int $telegramId;
    private string $username;
    private string $email;
    private \DateTime $createdAt;

    public function __construct(
        int $id,
        int $telegramId,
        string $username,
        string $email
    ) {
        $this->id = $id;
        $this->telegramId = $telegramId;
        $this->username = $username;
        $this->email = $email;
        $this->createdAt = new \DateTime();
    }

    // Getters
    public function getId(): int { return $this->id; }
    public function getTelegramId(): int { return $this->telegramId; }
    public function getUsername(): string { return $this->username; }
    public function getEmail(): string { return $this->email; }
    public function getCreatedAt(): \DateTime { return $this->createdAt; }
}
```

## إضافة قاعدة بيانات

### استخدام PDO

```php
<?php

namespace InfobipBot\Database;

use PDO;

class Database
{
    private PDO $connection;

    public function __construct()
    {
        $dsn = sprintf(
            'mysql:host=%s;dbname=%s',
            Config::get('database.host'),
            Config::get('database.name')
        );

        $this->connection = new PDO(
            $dsn,
            Config::get('database.user'),
            Config::get('database.password')
        );

        $this->connection->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    }

    public function query(string $sql, array $params = []): array
    {
        $stmt = $this->connection->prepare($sql);
        $stmt->execute($params);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    public function execute(string $sql, array $params = []): int
    {
        $stmt = $this->connection->prepare($sql);
        $stmt->execute($params);
        return $stmt->rowCount();
    }
}
```

## معالجة الأخطاء

### الطريقة الموصى بها

```php
try {
    $result = $this->infobipService->sendSms($phone, $message);

    if (!$result['success']) {
        throw new \Exception($result['error']);
    }

    // معالجة النتيجة الناجحة
} catch (\Exception $e) {
    // تسجيل الخطأ
    error_log($e->getMessage());

    // إرسال رسالة خطأ للمستخدم
    $this->telegramService->sendMessage(
        $this->chatId,
        "❌ حدث خطأ: " . $e->getMessage()
    );
}
```

## الاختبار

### إنشاء اختبارات وحدة

```php
<?php

namespace Tests;

use PHPUnit\Framework\TestCase;
use InfobipBot\Services\TelegramService;

class TelegramServiceTest extends TestCase
{
    private TelegramService $service;

    protected function setUp(): void
    {
        $this->service = new TelegramService();
    }

    public function testSendMessage(): void
    {
        $result = $this->service->sendMessage(
            12345,
            "Test message"
        );

        $this->assertTrue($result['success']);
        $this->assertNotNull($result['message_id']);
    }
}
```

## أفضل الممارسات

1. **استخدم أسماء واضحة**: استخدم أسماء متغيرات وفئات واضحة وموصوفة.

2. **التعليقات**: أضف تعليقات توضيحية للأكواد المعقدة.

3. **معالجة الأخطاء**: تعامل مع جميع الأخطاء المحتملة بشكل صحيح.

4. **الأمان**: لا تشارك بيانات الاعتماد أو المفاتيح السرية.

5. **الأداء**: تجنب الحلقات غير الضرورية والاستعلامات المتكررة.

6. **التوثيق**: وثق الكود والميزات الجديدة.

## الاختبار المحلي

```bash
# اختبار أمر معين
php cli.php send-sms +1234567890 "Test message"

# اختبار الاتصال
php cli.php test-telegram
php cli.php test-infobip

# تشغيل الخادم
php server.php
```

## النشر على الإنتاج

1. **استخدم متغيرات البيئة**: لا تضع بيانات الاعتماد في الكود.

2. **تفعيل وضع الإنتاج**: عيّن `APP_ENV=production` و `APP_DEBUG=false`.

3. **استخدم HTTPS**: تأكد من أن جميع الاتصالات آمنة.

4. **قم بالنسخ الاحتياطي**: احفظ نسخة احتياطية من قاعدة البيانات.

5. **المراقبة**: راقب السجلات والأخطاء.

## المراجع

- [Infobip API Documentation](https://www.infobip.com/docs/api)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [PHP Best Practices](https://www.php-fig.org/)
